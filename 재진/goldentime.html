<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>

<body>
    <div id="map" style="width: 100%; height: 1000px"></div>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c5399006405c2e57b967f4927e409e76&libraries=services"></script>

    <script>
        const url_goldentime = 'https://api.odcloud.kr/api/15086458/v1/uddi:c34efea2-ff75-43c2-9203-d29d7f9c6708?page=1&perPage=100&serviceKey=0D0v2Q2hxIThZmHHWv0XEQN7P9uI%2BV4VY%2BcXg%2BpakTWFNEz9FuobOPSU4%2Fj%2FLUZrXRFcvWkSrc4fo%2B79pvi%2FWg%3D%3D';
        const url_firestation = 'https://api.odcloud.kr/api/15048243/v1/uddi:818f12a7-70c1-4aff-81a0-80d5db5be9fb?page=1&perPage=100&serviceKey=0D0v2Q2hxIThZmHHWv0XEQN7P9uI%2BV4VY%2BcXg%2BpakTWFNEz9FuobOPSU4%2Fj%2FLUZrXRFcvWkSrc4fo%2B79pvi%2FWg%3D%3D';
        const url_119station = 'https://api.odcloud.kr/api/15065056/v1/uddi:26c81fc7-9e59-4868-883f-965570d4cc38?page=1&perPage=100&serviceKey=0D0v2Q2hxIThZmHHWv0XEQN7P9uI%2BV4VY%2BcXg%2BpakTWFNEz9FuobOPSU4%2Fj%2FLUZrXRFcvWkSrc4fo%2B79pvi%2FWg%3D%3D';
        //const url_fsarea = 'http://api.vworld.kr/req/data?service=data&request=GetFeature&data=LT_C_USFSFFB&key=E19E43BE-F61B-31AF-BAFE-1E275E4BCE41&domain=http://127.0.0.1:5500/goldentime.html&geomFilter=point(10 10)';
        // 인포윈도우 표시 열기
        function mouseOverListener(map, marker, infoWindow) {
            return function () {
                infoWindow.open(map, marker);
            };
        }

        function mouseOutListener(infoWindow) {
            return function () {
                infoWindow.close();
            };
        }

        var mapContainer = document.getElementById("map"); // 지도를 표시할 div
        var mapOption = {
            center: new kakao.maps.LatLng(37.566535, 126.9779692), // 지도의 중심좌표
            level: 6, // 지도의 확대 레벨
            mapTypeId: kakao.maps.MapTypeId.ROADMAP // 지도종류
        };

        var map = new kakao.maps.Map(mapContainer, mapOption);


        //소방서 마커 이미지 옵션
        var fs_image_src = 'firestation.png';
        var fs_image_size = new kakao.maps.Size(20, 20);
        var fs_image_op = { offset: new kakao.maps.Point(10, 10) };
        var firelat;
        var firelng;

        fetch(url_goldentime)
            .then((res) => res.json())
            .then((resJson) => {

                // 화재현황(골든타임) 데이터 접근 centers
                var centers = resJson.data;

                fetch(url_firestation)
                    .then((res) => res.json())
                    .then((resJson) => {

                        //소방서 위치 데이터 접근 firestation
                        var firestation = resJson.data;
                        var fs_markers = [];

                        fetch(url_119station)
                            .then((res) => res.json())
                            .then((resJson) => {

                                //119 안전센터 데이터 접근 fire119
                                var fire119 = resJson.data;
                                var fire119markers = [];
                                let colordiff;

                                //마커 이미지 생성
                                var fs_image = new kakao.maps.MarkerImage(fs_image_src, fs_image_size, fs_image_op);
                                for (var i = 0; i < firestation.length; i++) {
                                    let fs_address = firestation[i]["주소"]; //소방서 주소
                                    let fs_name = firestation[i]["소방서"]; //소방서 이름
                                    let gofs = centers[i]["출동소방서"]; //화재지역 출동 소방서
                                    let go119 = centers[i]["출동안전센터_지역대"]; //화재지역 출동 119센터

                                    //소방서 위치 표시 및 주변 안전지대 형성
                                    new kakao.maps.services.Geocoder().addressSearch(fs_address, function (result, status) {
                                        if (status === kakao.maps.services.Status.OK) {
                                            //소방서 주소 좌표
                                            var lat = result[0].y;
                                            var lng = result[0].x;

                                            // 마커를 생성합니다.
                                            var fs_marker = new kakao.maps.Marker({
                                                position: new kakao.maps.LatLng(lat, lng),
                                                image: fs_image,
                                                map: map
                                            });

                                            var infoWindow = new kakao.maps.InfoWindow({
                                                content: fs_name //소방서 이름
                                            });

                                            fs_markers.push(fs_marker);
                                            kakao.maps.event.addListener(fs_marker, "mouseover", mouseOverListener(map, fs_marker, infoWindow));
                                            kakao.maps.event.addListener(fs_marker, "mouseout", mouseOutListener(infoWindow));
                                            // 원을 생성하고 지도에 표시합니다.

                                            var circle = new kakao.maps.Circle({
                                                //소방서 근처는 아마 안전할 것이므로 초록색 원을 생성
                                                center: new kakao.maps.LatLng(lat, lng),
                                                radius: 1000,
                                                strokeWeight: 3,
                                                strokeColor: 'green',
                                                strokeOpacity: 1,
                                                strokeStyle: 'solid',
                                                fillColor: 'green',
                                                fillOpacity: 0.5
                                            });
                                            circle.setMap(map);


                                        }
                                    });

                                    //골든타임을 구하기 위한 코드
                                    let arrivetime = String(centers[i]["현장도착시각"]); //시각이 12:30으로 되어있으므로 : 분리를 해서 시간과 분으로 표시
                                    let atimeParts = arrivetime.split(":");
                                    let ahours = parseInt(atimeParts[0]); // 시간
                                    let aminutes = parseInt(atimeParts[1]); // 분

                                    let calltime = String(centers[i]["신고시각"]);
                                    let ctimeParts = calltime.split(":");
                                    let chours = parseInt(ctimeParts[0]); // 시간
                                    let cminutes = parseInt(ctimeParts[1]); // 분

                                    let atotal = ahours * 60 + aminutes;
                                    let ctotal = chours * 60 + cminutes;
                                    let timediff = atotal - ctotal; //골든타임은 분 단위이므로 분단위로 계산 후 저장
                                    //주소가 시 구 동 리 따로 되어있어 이를 하나로 붙여 주소를 생성
                                    let fire_address = centers[i]["긴급구조시"] + " " + centers[i]["긴급구조구"] + " " + centers[i]["긴급구조동"] + " " + centers[i]["긴급구조리"];


                                    //골든타임은 도착시각 - 신고시각 = 7분 이내 이므로
                                    if (timediff <= 7) {
                                        colordiff = 'green';
                                    }
                                    else {
                                        colordiff = 'red';
                                    }


                                    new kakao.maps.services.Geocoder().addressSearch(fire_address, function (result, status) {
                                        if (status === kakao.maps.services.Status.OK) {
                                            //화재가 난 지역의 좌표를 저장
                                            var lat = result[0].y;
                                            var lng = result[0].x;

                                            // 화재가 난 지역의 원을 생성하고 지도에 표시합니다.

                                            var circle = new kakao.maps.Circle({
                                                center: new kakao.maps.LatLng(lat, lng),
                                                radius: 1000,
                                                strokeWeight: 3,
                                                strokeColor: colordiff,
                                                strokeOpacity: 1,
                                                strokeStyle: 'solid',
                                                fillColor: colordiff,
                                                fillOpacity: 0.5
                                            });
                                            circle.setMap(map);

                                            kakao.maps.event.addListener(circle, 'click', function (mouseEvent) {

                                                for (var j = 0; j < firestation.length; j++) {
                                                    //조건문이 쓸데없이 복잡한 이유는 데이터 중 하나가 소방서 이름만 있고 주소가 없기 때문이다.
                                                    //심지어 또다른 하나는 소방서 주소는 있지만 전국의 소방서를 나타낸 데이터가 아니라 둘의 자료를 이렇게 접근한다.
                                                    //만약 두 소방서의 이름이 같으면
                                                    if (go119 == fire119[j]["119안전센터명"]) {
                                                        new kakao.maps.services.Geocoder().addressSearch(fire119[j]["주소"], function (result, status) { //소방서의 주소로 검색하여 찾는다
                                                            if (status === kakao.maps.services.Status.OK) {
                                                                var fslat = result[0].y;
                                                                var fslng = result[0].x;

                                                                //선 생성
                                                                var linePath = [ //소방서의 좌표와 원의 좌표를 받는다
                                                                    new kakao.maps.LatLng(lat, lng),
                                                                    new kakao.maps.LatLng(fslat, fslng)
                                                                ];

                                                                // 지도에 표시할 선을 생성합니다
                                                                var polyline = new kakao.maps.Polyline({
                                                                    path: linePath, // 선을 구성하는 좌표배열 입니다
                                                                    strokeWeight: 5, // 선의 두께 입니다
                                                                    strokeColor: 'blue', // 선의 색깔입니다
                                                                    strokeOpacity: 0.7, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
                                                                    strokeStyle: 'solid' // 선의 스타일입니다
                                                                });


                                                                // 지도에 선을 표시합니다 
                                                                polyline.setMap(map);
                                                            }
                                                        });
                                                    }

                                                    else if (firestation[j]["소방서"] == gofs) {
                                                        new kakao.maps.services.Geocoder().addressSearch(firestation[j]["주소"], function (result, status) { //소방서의 주소로 검색하여 찾는다
                                                            if (status === kakao.maps.services.Status.OK) {
                                                                var fslat = result[0].y;
                                                                var fslng = result[0].x;

                                                                //선 생성
                                                                var linePath = [ //소방서의 좌표와 원의 좌표를 받는다
                                                                    new kakao.maps.LatLng(lat, lng),
                                                                    new kakao.maps.LatLng(fslat, fslng)
                                                                ];

                                                                // 지도에 표시할 선을 생성합니다
                                                                var polyline = new kakao.maps.Polyline({
                                                                    path: linePath, // 선을 구성하는 좌표배열 입니다
                                                                    strokeWeight: 5, // 선의 두께 입니다
                                                                    strokeColor: 'blue', // 선의 색깔입니다
                                                                    strokeOpacity: 0.7, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
                                                                    strokeStyle: 'solid' // 선의 스타일입니다
                                                                });


                                                                // 지도에 선을 표시합니다.
                                                                polyline.setMap(map);

                                                            }
                                                        });

                                                    }



                                                }
                                            });


                                        }
                                    });
                                }




                                for (var i = 0; i < fire119.length; i++) {
                                    let fs_address = fire119[i]["주소"];
                                    let fs_name = fire119[i]["119안전센터명"]
                                    //소방서 위치 표시 및 주변 안전지대 형성
                                    new kakao.maps.services.Geocoder().addressSearch(fs_address, function (result, status) {
                                        if (status === kakao.maps.services.Status.OK) {
                                            firelat = result[0].y;
                                            firelng = result[0].x;

                                            // 마커를 생성합니다.
                                            var fire119marker = new kakao.maps.Marker({
                                                position: new kakao.maps.LatLng(firelat, firelng),
                                                image: fs_image,
                                                map: map
                                            });

                                            var infoWindow = new kakao.maps.InfoWindow({
                                                content: fs_name
                                            });

                                            fire119markers.push(fire119marker);
                                            kakao.maps.event.addListener(fire119marker, "mouseover", mouseOverListener(map, fire119marker, infoWindow));
                                            kakao.maps.event.addListener(fire119marker, "mouseout", mouseOutListener(infoWindow));
                                            // 원을 생성하고 지도에 표시합니다.

                                            var circle = new kakao.maps.Circle({
                                                center: new kakao.maps.LatLng(firelat, firelng),
                                                radius: 1000,
                                                strokeWeight: 3,
                                                strokeColor: 'green',
                                                strokeOpacity: 1,
                                                strokeStyle: 'solid',
                                                fillColor: 'green',
                                                fillOpacity: 0.5
                                            });
                                            circle.setMap(map);


                                        }


                                    });
                                }
                            });



                    });
            });





    </script>

</body>

</html>